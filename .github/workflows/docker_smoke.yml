name: docker-smoke-ocr-service

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "*" ]
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (dev)
        run: |
          docker build -t ocr-service:smoke -f Dockerfile .

      - name: Start stack
        run: |
          cd docker
          docker compose -f docker-compose.base.yml -f docker-compose.dev.yml up -d
        env:
          OCR_SERVICE_EXTERNAL_PORT: 18090
          OCR_SERVICE_TEXT_ONLY_EXTERNAL_PORT: 18091

      - name: Wait for health
        env:
          OCR_SERVICE_EXTERNAL_PORT: 18090
          OCR_SERVICE_TEXT_ONLY_EXTERNAL_PORT: 18091
        run: |
          set -euo pipefail
          timeout=600
          interval=5
          url="http://localhost:${OCR_SERVICE_EXTERNAL_PORT:-18090}/api/health"

          end=$((SECONDS+timeout))
          while [ $SECONDS -lt $end ]; do
            if curl -fsS "$url" >/dev/null; then
              echo "Service healthy at $url"
              exit 0
            fi
            sleep $interval
          done
          echo "Service failed to become healthy within ${timeout}s"
          exit 1

      - name: Check info
        env:
          OCR_SERVICE_EXTERNAL_PORT: 18090
        run: |
          curl -fsS "http://localhost:${OCR_SERVICE_EXTERNAL_PORT:-18090}/api/info"

      - name: Check health (text-only port)
        env:
          OCR_SERVICE_TEXT_ONLY_EXTERNAL_PORT: 18091
        run: |
          curl -fsS "http://localhost:${OCR_SERVICE_TEXT_ONLY_EXTERNAL_PORT:-18091}/api/health"

      - name: Logs on failure
        if: failure()
        run: |
          cd docker
          docker compose -f docker-compose.dev.yml logs --no-color

      - name: Teardown
        if: always()
        run: |
          cd docker
          make stop-all
